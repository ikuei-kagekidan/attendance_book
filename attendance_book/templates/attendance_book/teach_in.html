<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    
    {% load static %}
    <script src="{% static 'attendance_book/jquery-3.6.0.min.js' %}"></script>
    <script>
        $(function () {
            $("#create-timetable-buutton").on("click", () => {
                $("#timetable-dialog").show("slow")
            });

            $("#timetable-dialog-close").on("click", () => {
                $("#timetable-dialog").hide("slow");
            });

            const at_json = {{ attendance_status | safe }};
            for (const key in at_json) {
                for (let i=0; i<9; i++) {
                    if (i in at_json[key]) {
                        let css_selector = "#" + key + "-" + String(i);
                        let attend_val = at_json[key][i];
                        $(css_selector).append(`<input type="number" id="attend-number-${key}-${i}" class="attend-number" value="${attend_val}" name="status-${key}-${i}">`);
                        $(css_selector).append(`<input type="number" id="attend-number-prev-${key}-${i}" class="attend-number-prev" value="${attend_val}">`);
                        if (attend_val == 0) {
                            $(css_selector).append(`<button type="button" id="attend-button-${key}-${i}" class="attend-button">出席</button>`);
                        }
                        else if (attend_val == 1) {
                            $(css_selector).append(`<button type="button" id="attend-button-${key}-${i}" class="attend-button" style="color: black">欠席</button>`);
                        }
                        let attend_button = $(`#attend-button-${key}-${i}`);
                        let attend_number = $(`#attend-number-${key}-${i}`);
                        let attend_number_prev = $(`#attend-number-prev-${key}-${i}`);
                        attend_button.on("click", () => {
                            if (attend_number.val() == "0") {                 
                                attend_button.text("欠席");
                                attend_button.css({"color": "black"});
                                attend_number.val("1");
                            }
                            else if (attend_number.val() == "1") {
                                attend_button.text("出席");
                                attend_button.css({"color": "white"});
                                attend_number.val("0");
                            }
                            if (attend_number_prev.val() == attend_number.val()) {
                                attend_button.css({"background-color": "#40bf80"});
                            }
                            else if (attend_number_prev.val() != attend_number.val()) {
                                attend_button.css({"background-color": "lightsalmon"});
                            }
                        });
                    }
                }
            }

            $("#date-input").on("change", () => {
                $("#date").submit();
            });

            const tt_json = {{ timetable | safe }};
            for (const key in tt_json) {
                if (key != "0") {
                    const sp = Number(key);
                    const pl = tt_json[key]["period_length"];
                    $(`#subject-period-${sp}`).attr("colspan", pl);
                    $(`#subject-period-${sp}`).text(tt_json[key]["subject"])
                    for (let i=sp+1; i<sp+pl; i++) {
                        $(`#subject-period-${i}`).remove();
                    }
                }
            }

            $("#update-status-button").on("click", () => {
                $("#update-status-form").submit()
            });
        });
    </script>
    <style>
        body{
            background-color:white;
        }

        .container {
            position: relative;
            border-radius: 2px;
            background-color: #f2f2f2;
            padding: 10px 20px 10px 20px;
        } 

        #date {
            width:200px;
            height:30px;
            padding:10px;
            background-color:#b3e6cc;
            border-radius:2px;
        }

        th {
            width:100px;
            height:25px;
            padding:5px;
            background-color:#66cc99;
            border-radius:1px;
        }

        .attend-number,.attend-number-prev {
            display: none;
        }

        .attend-button {
            background-color:#40bf80;
	        padding-left: 35px;
            padding-right: 35px;
            font-size: 20px;
            border-radius:4px;
            color:white;
        }

        .attend-button:hover {
            background-color: rgba(200, 200, 220, 1) !important;
        }

        .attend-button:active {
	        box-shadow: inset -2px -2px 3px rgba(255, 255, 255, .6),
                        inset 2px 2px 3px rgba(0, 0, 0, .6);
}   </style>
</head>
<body>
    <p id="textback" style="display: none">message</p>
    <form id="date" action="{% url 'attendance_book:teacher-input-post' %}" method="post">
        {% csrf_token %}
        date
        <input id="date-input" type="date" name="date" value="{{ d|date:'Y-m-d' }}">
        <input type="input" name="search-date" value="検索" style="display: none">
    </form>
    <button id="create-timetable-buutton">今日の時間割を生成する</button>
    <button id="update-status-button">出席状況を更新する</button>

    <form id="update-status-form" action="{% url 'attendance_book:teacher-input-post' %}" method="post">
        {% csrf_token %}
        <input type="input" name="update-status" value="更新" style="display: none">
        <input type="text" name="date" value="{{ d|date:'Y-m-d' }}" style="display:none">
        <table class="container">
            <tr>
                <th></th>
                <th></th>
                <th></th>
                <th id="subject-period-1"></th>
                <th id="subject-period-2"></th>
                <th id="subject-period-3"></th>
                <th id="subject-period-4"></th>
                <th id="subject-period-5"></th>
                <th id="subject-period-6"></th>
                <th id="subject-period-7"></th>
                <th id="subject-period-8"></th>
            </tr>
            <tr>
                <th>番号</th>
                <th>名前</th>
                <th><button id="HR-button">HR</button></th>
                <th><button>1</button></th>
                <th><button>2</button></th>
                <th><button>3</button></th>
                <th><button>4</button></th>
                <th><button>5</button></th>
                <th><button>6</button></th>
                <th><button>7</button></th>
                <th><button>8</button></th>
            </tr>
            {% for student in student_list %}
            <tr id="student-{{ student.class_num }}">
                <th>{{ student.class_num }}</th>
                <th>{{ student.person.name }}</th>
                <td id="{{ student.student_num }}-0"></td>
                <td id="{{ student.student_num }}-1"></td>
                <td id="{{ student.student_num }}-2"></td>
                <td id="{{ student.student_num }}-3"></td>
                <td id="{{ student.student_num }}-4"></td>
                <td id="{{ student.student_num }}-5"></td>
                <td id="{{ student.student_num }}-6"></td>
                <td id="{{ student.student_num }}-7"></td>
                <td id="{{ student.student_num }}-8"></td>
            </tr>
            {% endfor %}
        </table>
    </form>

    <div id="timetable-dialog" style="display:none">
        <form action="{% url 'attendance_book:teacher-input-post' %}" method="post">
            {% csrf_token %}
            <input type="text" name="date" value="{{ d|date:'Y-m-d' }}" style="display:none">
            <input type="submit" name="create-timetable" value="作成">
        </form>
        <button id="timetable-dialog-close">閉じる</button>
    </div>
</body>
</html>